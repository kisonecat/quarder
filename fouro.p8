pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
-- in2the4
-- by kisonecat

beats_per_second = 2
last_beat = 0

beats = {}
beat_depth = 5

labels = {}
bolded = {}
cards = {}

selected = {}
for i=1, 10 do
   selected[i] = 0
end
selected_count = 0

color_order = { 8, 3, 12}

function _init()
   for i=1, 10 do
      labels[i] = 48 + i - 1
      bolded[i] = 48 - 16 + i - 1       
   end

   shuffle()

   px = 1
   py = cards[px]
end

function shuffle()
   for i=1, 10 do
      cards[i] = i
   end

   for i=10, 2, -1 do
      local j = flr(rnd(i))+1
      local s = cards[j]
      cards[j] = cards[i]
      cards[i] = s
   end
end
    
function _update60()
   local move_x = false
   local move_y = false
   local move_select = false

   if (btnp(4) or btnp(5)) then
      selected_count = selected_count + 1
      selected[px] = selected_count
      move_select = true
      
      sfx(selected_count+1)      
   end
   
   if (btnp(1)) then
      px = px + 1
      move_x = true
   end
    
   if (btnp(0)) then
      px = px - 1
      move_x = true
   end

   if move_x then
      if (px < 1) px = 1
      if (px > 10) px = 10
      py = cards[px]
   end

   if (btnp(2)) then
      py = py + 1
      move_y = true
   end
    
   if (btnp(3)) then
      py = py - 1
      move_y = true
   end

   if move_y then
      if (py < 1) py = 1
      if (py > 10) py = 10
      for i=1,10 do
	 if cards[i] == py then
	    px = i
	 end
      end
   end

   if move_x or move_y then
      sfx(0)
   end

   local t = time()

   if flr(t * beats_per_second) > flr(last_beat * beats_per_second) then
      last_beat = t
      sfx(1)
   end
   
   if move_x or move_y or move_select then
      add( beats, t * beats_per_second)
      if #beats > beat_depth then
	 del( beats, beats[1] )
      end
   end
end

tile_size = 10

margin = (128 - tile_size * 10) / 2

function board_x(x)
   return (x-1)*tile_size + margin
end

function board_y(y)
   return 128 - tile_size - ((y-1)*tile_size + margin)
end

function draw_edges(sense, color)
   for i=1, 10 do
      local ci = cards[i]
      local xi = board_x(i) + 4
      local yi = board_y(ci) + 4
      for j=i+1, 10 do
	 local cj = cards[j]
	 local xj = board_x(j) + 4
	 local yj = board_y(cj) + 4

	 if ci * sense < cj * sense then
	    local inbetween = false
	    for k = i+1, j-1 do
	       local ck = cards[k]

	       if ci * sense < ck * sense and ck * sense < cj * sense then
		  inbetween = true
	       end
	    end

	    if inbetween == false then
	       line( xi, yi, xj, yj, color )
	    end
	 end
      end
   end   
end

function _draw()
   cls()

   print( beats[1], 0, 0, 7 )
   print( beats[2], 0, 5, 7 )
   print( beats[3], 0, 10, 7 )      
   
   draw_edges( 1, 2 )
   draw_edges( -1, 1 )   

   for i=1, 10 do
      local c = cards[i]
      if selected[i] == 0 then
	 pal()
	 pal(15, 0)
	 spr( labels[c], board_x(i), board_y(c) )
      else
	 pal()
	 pal(7, 0)
	 spr( bolded[c], board_x(i)+1, board_y(c) )
	 spr( bolded[c], board_x(i)-1, board_y(c) )
	 spr( bolded[c], board_x(i), board_y(c)+1 )
	 spr( bolded[c], board_x(i), board_y(c)-1 )

	 spr( bolded[c], board_x(i)+1, board_y(c)+1)
	 spr( bolded[c], board_x(i)-1, board_y(c)-1 )
	 spr( bolded[c], board_x(i)-1, board_y(c)+1 )
	 spr( bolded[c], board_x(i)+1, board_y(c)-1 )

	 pal(7, color_order[ selected[i] ] )
	 spr( bolded[c], board_x(i), board_y(c) )
      end
   end

   if (time() - last_beat < 0.1) then
      spr( 2, board_x(px) - 4, board_y(py) - 4, 2, 2 )
   else
      spr( 0, board_x(px) - 4, board_y(py) - 4, 2, 2 )
   end
   
end

__gfx__
02000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00820000000028000022200000022200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00288820028882000028802002088200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00080000000080000028888008888200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00080000000080000000800000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00020000000020000002800000082000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00020000000020000002800000082000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00080000000080000000800000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00080000000080000028888008888200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00288820028882000028802002088200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00820000000028000022200000022200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
02000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07777770007770000777777007777770077007700777777007777770077777700777777007777770000000000000000000000000000000000000000000000000
07777770007770000777777007777770077007700777777007777770077777700777777007777770000000000000000000000000000000000000000000000000
07700770000770000000077000000770077007700770000007700000077007700770077007700770000000000000000000000000000000000000000000000000
07700770000770000777777000777770077777700777777007777770000007700777777007777770000000000000000000000000000000000000000000000000
07700770000770000770000000000770000007700000077007700770000007700770077000000770000000000000000000000000000000000000000000000000
07777770000770000777777007777770000007700777777007777770000007700777777000000770000000000000000000000000000000000000000000000000
07777770000770000777777007777770000007700777777007777770000007700777777000000770000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0ffffff000ffff000ffff0000ffffff00ffffff00ffffff00fffff000ffffff00ffffff00ffffff0000000000000000000000000000000000000000000000000
0f7777f000f77f000f777f000f7777f00f7ff7f00f7777f00f777f000f7777f00f7777f00f7777f0000000000000000000000000000000000000000000000000
0f7ff7f000ff7f000ffff7f00ffff7f00f7ff7f00f7ffff00f7fff000f7ff7f00f7ff7f00f7ff7f0000000000000000000000000000000000000000000000000
0f7ff7f0000f7f000f7777f000f777f00f7777f00f7777f00f7777f00ffff7f00f7777f00f7777f0000000000000000000000000000000000000000000000000
0f7ff7f0000f7f000f7ffff00ffff7f00ffff7f00ffff7f00f7ff7f00000f7f00f7ff7f00ffff7f0000000000000000000000000000000000000000000000000
0f7777f0000f7f000f7777f00f7777f00000f7f00f7777f00f7777f00000f7f00f7777f00000f7f0000000000000000000000000000000000000000000000000
0ffffff0000fff000ffffff00ffffff00000fff00ffffff00ffffff00000fff00ffffff00000fff0000000000000000000000000000000000000000000000000
__sfx__
000100003052024510000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000400000942001400003000020000600026000460000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000c57000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000001057000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000001357000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__music__
00 02030444
00 40424344

